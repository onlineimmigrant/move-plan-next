# Chat History - Quick Reference Guide

## Database Migration

### Run This First!
```sql
-- Execute in Supabase SQL Editor
/database/migrations/enhance_chat_histories.sql
```

This adds:
- `bookmarked` column (boolean)
- `created_at` and `updated_at` timestamps
- Auto-update trigger for `updated_at`
- Cleanup function for 60-day retention
- Performance indexes

## New Features at a Glance

### 1. Auto-Save (No User Action Required)
- **First message** â†’ Chat auto-created with name: `"[First 20 chars]... - [Date]"`
- **Subsequent messages** â†’ Same chat updated
- **Example**: `"How do I reset my p... - Nov 5, 2025"`

### 2. Date-Grouped Chat List
```
Today
â”œâ”€ Chat 1 (3:45 PM)
â”œâ”€ Chat 2 (2:30 PM)

Yesterday
â”œâ”€ Chat 3 (Yesterday 11:00 AM)

Last 7 Days
â”œâ”€ Chat 4 (Nov 3, 9:15 AM)

Last 30 Days
â”œâ”€ Chat 5 (Oct 29, 2:00 PM)

October 2025
â”œâ”€ Chat 6 (Oct 15, 10:30 AM)
```

### 3. Inline Bookmark Toggle
- Click â­ icon to bookmark/unbookmark
- Bookmarked = filled yellow star
- Not bookmarked = outline (visible on hover)
- Bookmarked chats kept forever

### 4. Inline Rename
- Hover over chat â†’ Click pencil icon
- Type new name â†’ Press Enter (or click âœ“)
- Press Escape (or click âœ—) to cancel

### 5. New Chat Button
- Click "â• New Chat" in search modal
- Clears current conversation
- Ready for fresh start

## User Workflows

### Save a Chat (Bookmark It)
```
Option 1 (From Search Modal):
1. Open search modal
2. Find your chat
3. Click bookmark icon
4. Done! â­

Option 2 (From Current Chat):
1. Click bookmark button in header
2. Enter/edit name
3. Click save
4. Done! (Also bookmarked)
```

### Rename a Chat
```
1. Open search modal
2. Hover over chat
3. Click pencil icon âœï¸
4. Type new name
5. Press Enter
6. Done!
```

### Load Previous Chat
```
1. Click search button (magnifying glass)
2. Click chat name
3. Modal closes, chat loads
4. Continue conversation (updates that chat)
```

### Start New Chat
```
1. Click "New Chat" button in search modal
   OR
2. Just start typing (if chat is empty)
3. First message creates new chat automatically
```

## Technical Reference

### Auto-Save Function
```typescript
// Called after every AI response
await autoSaveChatHistory(updatedMessages);

// Logic:
if (currentChatId exists) {
  â†’ Update existing chat (UPDATE query)
} else {
  â†’ Create new chat (INSERT query)
  â†’ Set currentChatId to new chat ID
}
```

### New Functions Available
```typescript
// Toggle bookmark status
await toggleBookmark(historyId, true/false)

// Rename chat
await renameHistory(historyId, "New Name")

// Start fresh conversation
startNewChat()

// Refresh chat list from DB
await refreshChatHistories(profileId)
```

### Modal Props
```typescript
<SearchHistoryModal
  isOpen={boolean}
  onClose={() => void}
  chatHistories={ChatHistory[]}
  onSelectHistory={(history) => void}
  onToggleBookmark={(id, bookmarked) => Promise<void>}
  onRenameHistory={(id, name) => Promise<void>}
  onNewChat={() => void}
/>
```

### ChatHistory Type
```typescript
interface ChatHistory {
  id: number;
  name: string;
  messages: Message[];
  bookmarked: boolean;      // â­ Bookmark status
  created_at: string;       // ğŸ“… Creation date
  updated_at: string;       // ğŸ• Last update
}
```

## State Management

### New State Variables
```typescript
const [currentChatId, setCurrentChatId] = useState<number | null>(null);
```

### State Flow
```
New Chat:
currentChatId = null â†’ First message â†’ Auto-save â†’ currentChatId = newId

Load Chat:
Click in history â†’ loadChatHistory() â†’ currentChatId = loadedId

Continue Chat:
Send message â†’ autoSaveChatHistory() â†’ Updates currentChatId chat
```

## Database Queries

### Fetch Histories (Updated)
```typescript
const { data } = await supabase
  .from('ai_chat_histories')
  .select('id, name, messages, bookmarked, created_at, updated_at')
  .eq('user_id', userId)
  .order('updated_at', { ascending: false });
```

### Auto-Save (Insert)
```typescript
const { data: newChat } = await supabase
  .from('ai_chat_histories')
  .insert({
    user_id: profileId,
    name: autoGeneratedName,
    messages: messagesArray,
    bookmarked: false
  })
  .select()
  .single();
```

### Auto-Save (Update)
```typescript
await supabase
  .from('ai_chat_histories')
  .update({ 
    messages: updatedMessages,
    updated_at: new Date().toISOString()
  })
  .eq('id', currentChatId);
```

### Toggle Bookmark
```typescript
await supabase
  .from('ai_chat_histories')
  .update({ 
    bookmarked: true/false,
    updated_at: new Date().toISOString()
  })
  .eq('id', historyId);
```

### Rename Chat
```typescript
await supabase
  .from('ai_chat_histories')
  .update({ 
    name: newName,
    updated_at: new Date().toISOString()
  })
  .eq('id', historyId);
```

## Cleanup Policy

### Automatic (60 Days)
```sql
-- Run this function to cleanup old chats
SELECT cleanup_old_chat_histories();

-- What it does:
DELETE FROM ai_chat_histories
WHERE bookmarked = false
  AND created_at < (now() - INTERVAL '60 days');
```

### Schedule with pg_cron (Optional)
```sql
SELECT cron.schedule(
  'cleanup-old-chats',
  '0 2 * * *',  -- Every day at 2 AM
  $$ SELECT cleanup_old_chat_histories(); $$
);
```

## UI Elements

### Search Modal Layout
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” Chat History              [âœ•]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ğŸ” Search...] [â• New Chat]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚ TODAY                               â”‚
â”‚ â­ Important chat (10 messages)     â”‚
â”‚ â—‹ Quick question (2 messages)       â”‚
â”‚                                     â”‚
â”‚ YESTERDAY                           â”‚
â”‚ â—‹ Help with setup (5 messages)      â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’¡ Chats saved for 60 days.        â”‚
â”‚    Bookmark to keep forever.        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Inline Edit Mode
```
Before hover:
â­ Important chat (10 messages)

On hover:
â­ Important chat (10 messages) [âœï¸]

In edit mode:
â­ [Important chat      ] [âœ“] [âœ•]
```

## Testing Checklist

### Before Deployment
- [ ] Run database migration
- [ ] Test auto-save on first message
- [ ] Test auto-update on second message
- [ ] Test bookmark toggle (both directions)
- [ ] Test inline rename (Enter and Escape)
- [ ] Test new chat button
- [ ] Test date grouping with various dates
- [ ] Test search filtering
- [ ] Test loading previous chat
- [ ] Verify updated_at timestamp updates correctly

### After Deployment
- [ ] Check chat appears in "Today" section
- [ ] Verify auto-generated name format
- [ ] Test bookmark preservation across sessions
- [ ] Verify 60-day cleanup (after 60 days)
- [ ] Check performance with 100+ chats

## Common Issues & Solutions

### Chat not saving?
- Check user is authenticated
- Verify database migration ran successfully
- Check browser console for errors

### Timestamp not updating?
- Ensure trigger was created in migration
- Check `updated_at` column exists
- Verify trigger function is working

### Date grouping incorrect?
- Check client timezone vs server timezone
- Verify `updated_at` format is ISO string
- Ensure dates are being parsed correctly

### Bookmark not persisting?
- Check `bookmarked` column default is false
- Verify UPDATE query includes bookmarked field
- Check RLS policies allow UPDATE

## Performance Notes

### Indexes Created
```sql
-- Sorting by updated_at (most common query)
idx_ai_chat_histories_updated_at (user_id, updated_at DESC)

-- Finding bookmarked chats
idx_ai_chat_histories_bookmarked (user_id, bookmarked) WHERE bookmarked = true

-- Date-based queries
idx_ai_chat_histories_created_date (user_id, DATE(created_at))
```

### Query Optimization
- Fetch only necessary fields in SELECT
- Order by indexed columns (updated_at)
- Use WHERE clause on indexed columns
- Limit results if displaying only recent chats

## Summary

âœ… **Zero manual action** - Chats save automatically
âœ… **Smart organization** - Date-grouped, sorted by recency  
âœ… **Quick actions** - Inline bookmark & rename
âœ… **Clean maintenance** - 60-day auto-cleanup
âœ… **Modern UX** - Smooth, intuitive, no page reloads

**Remember**: Run the database migration first! All features depend on the new schema.
